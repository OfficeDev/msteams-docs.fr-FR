---
title: Microsoft Teams Flux d’authentification pour les bots
description: Décrit le flux Microsoft Teams’authentification dans les bots
keywords: équipes authentification flux bots
localization_priority: Normal
ms.topic: overview
ms.openlocfilehash: f3bf73c105dc38e1cea515bfa7bb7d5324b02ce4
ms.sourcegitcommit: 51e4a1464ea58c254ad6bd0317aca03ebf6bf1f6
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 05/19/2021
ms.locfileid: "52565901"
---
# <a name="authentication-flow-for-bots-in-microsoft-teams"></a><span data-ttu-id="f5dac-104">Flux d’authentification pour les bots Microsoft Teams</span><span class="sxs-lookup"><span data-stu-id="f5dac-104">Authentication flow for bots in Microsoft Teams</span></span>

<span data-ttu-id="f5dac-105">OAuth 2.0 est une norme ouverte pour l’authentification et l’autorisation utilisée par Azure Active Directory (Azure AD) et de nombreux autres fournisseurs d’identité.</span><span class="sxs-lookup"><span data-stu-id="f5dac-105">OAuth 2.0 is an open standard for authentication and authorization used by Azure Active Directory (Azure AD) and many other identity providers.</span></span> <span data-ttu-id="f5dac-106">Une compréhension de base d’OAuth 2.0 est une condition préalable pour travailler avec l’authentification Teams; [voici un bon aperçu qui](https://aaronparecki.com/oauth-2-simplified/) est plus facile à suivre que la spécification [formelle](https://oauth.net/2/).</span><span class="sxs-lookup"><span data-stu-id="f5dac-106">A basic understanding of OAuth 2.0 is a prerequisite for working with authentication in Teams; [here's a good overview](https://aaronparecki.com/oauth-2-simplified/) that's easier to follow than the [formal specification](https://oauth.net/2/).</span></span> <span data-ttu-id="f5dac-107">Flux d’authentification pour les onglets et les bots est un peu différent - onglets sont très similaires aux sites Web afin qu’ils puissent utiliser OAuth 2.0 directement, tandis que les bots ne sont pas et doivent faire quelques choses différemment - mais les concepts de base sont identiques.</span><span class="sxs-lookup"><span data-stu-id="f5dac-107">Authentication flow for tabs and bots is a little different — tabs are very similar to websites so they can use OAuth 2.0 directly, while bots aren't and must do a few things differently — but the core concepts are identical.</span></span>

<span data-ttu-id="f5dac-108">Consultez l’exemple GitHub repo [Microsoft Teams’authentification](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/app-auth/nodejs) pour un exemple qui démontre le flux d’authentification pour les bots utilisant Node.js et le type de subvention de [code d’autorisation OAuth 2.0](https://oauth.net/2/grant-types/authorization-code/).</span><span class="sxs-lookup"><span data-stu-id="f5dac-108">See the GitHub repo [Microsoft Teams Authentication Sample](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/app-auth/nodejs) for an example that demonstrates authentication flow for bots using Node.js and the [OAuth 2.0 authorization code grant type](https://oauth.net/2/grant-types/authorization-code/).</span></span>

![Diagramme de séquence d’authentification bot](../../../assets/images/authentication/bot_auth_sequence_diagram.png)

1. <span data-ttu-id="f5dac-110">L’utilisateur envoie un message au bot.</span><span class="sxs-lookup"><span data-stu-id="f5dac-110">The user sends a message to the bot.</span></span>
2. <span data-ttu-id="f5dac-111">Le bot détermine si l’utilisateur doit se connecter.</span><span class="sxs-lookup"><span data-stu-id="f5dac-111">The bot determines if the user needs to sign in.</span></span>
   <span data-ttu-id="f5dac-112">Dans cet exemple, le bot stocke le jeton d’accès dans sa boutique de données utilisateur.</span><span class="sxs-lookup"><span data-stu-id="f5dac-112">In this example, the bot stores the access token in its user data store.</span></span> <span data-ttu-id="f5dac-113">Il demande à l’utilisateur de se connecter s’il n’a pas de jeton validé pour le fournisseur d’identité sélectionné.</span><span class="sxs-lookup"><span data-stu-id="f5dac-113">It asks the user to sign in if it doesn't have a validated token for the selected identity provider.</span></span> <span data-ttu-id="f5dac-114">([Voir le code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span><span class="sxs-lookup"><span data-stu-id="f5dac-114">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span></span>
3. <span data-ttu-id="f5dac-115">Le bot construit l’URL à la page de début du flux d’authentification, et envoie une carte à l’utilisateur avec une `signin` action.</span><span class="sxs-lookup"><span data-stu-id="f5dac-115">The bot constructs the URL to the start page of the authentication flow, and sends a card to the user with a `signin` action.</span></span> <span data-ttu-id="f5dac-116">([Voir le code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span><span class="sxs-lookup"><span data-stu-id="f5dac-116">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span></span></br>
    <span data-ttu-id="f5dac-117">Comme d’autres flux d’application auth en Teams, la page de démarrage doit être dans un domaine qui est sur votre `validDomains` liste, et dans le même domaine que la page de redirection post-connexion.</span><span class="sxs-lookup"><span data-stu-id="f5dac-117">Like other application auth flows in Teams, the start page must be in a domain that's on your `validDomains` list, and in the same domain as the post-login redirect page.</span></span>
    > [!IMPORTANT] 
    > <span data-ttu-id="f5dac-118">Le flux de subvention du code d’autorisation OAuth 2.0 nécessite un paramètre dans la demande `state` d’authentification qui contient un jeton de session unique pour empêcher une attaque [de falsification de demande inter-sites.](https://en.wikipedia.org/wiki/Cross-site_request_forgery)</span><span class="sxs-lookup"><span data-stu-id="f5dac-118">The OAuth 2.0 authorization code grant flow calls for a `state` parameter in the authentication request which contains a unique session token to prevent a [cross-site request forgery attack](https://en.wikipedia.org/wiki/Cross-site_request_forgery).</span></span> <span data-ttu-id="f5dac-119">L’exemple utilise une GUID générée au hasard.</span><span class="sxs-lookup"><span data-stu-id="f5dac-119">The example uses a randomly-generated GUID.</span></span>
4. <span data-ttu-id="f5dac-120">Lorsque l’utilisateur sélectionne le *bouton signin,* Teams une fenêtre contextup et navigue vers la page de démarrage.</span><span class="sxs-lookup"><span data-stu-id="f5dac-120">When the user selects the *signin* button, Teams opens a popup window and navigates to the start page.</span></span>
   > [!NOTE]
   > <span data-ttu-id="f5dac-121">La taille de la fenêtre pop-up peut être contrôlée par des paramètres de chaîne de requête de largeur et de hauteur dans l’URL.</span><span class="sxs-lookup"><span data-stu-id="f5dac-121">The size of the pop-up window can be controlled through width and height query string parameters in the URL.</span></span> <span data-ttu-id="f5dac-122">Par exemple, si vous ajoutez width=500 et height=500, la taille de la fenêtre pop-up est de 500x500 pixels.</span><span class="sxs-lookup"><span data-stu-id="f5dac-122">For example, if you add width=500 and height=500, the size of the pop-up window is 500x500 pixels.</span></span> <span data-ttu-id="f5dac-123">Teams affiche la fenêtre contexturée avec la taille de pixel donnée, jusqu’à un maximum qui est un pourcentage de la taille de la fenêtre principale.</span><span class="sxs-lookup"><span data-stu-id="f5dac-123">Teams displays the pop-up window with the given pixel size, up to a maximum that's a percentage of the size of the main window.</span></span>

5. <span data-ttu-id="f5dac-124">La page de démarrage redirige l’utilisateur vers le point de terminaison du `authorize` fournisseur d’identité.</span><span class="sxs-lookup"><span data-stu-id="f5dac-124">The start page redirects the user to the identity provider's `authorize` endpoint.</span></span> <span data-ttu-id="f5dac-125">([Voir le code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span><span class="sxs-lookup"><span data-stu-id="f5dac-125">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span></span>
6. <span data-ttu-id="f5dac-126">Sur le site du fournisseur, l’utilisateur se signe et donne accès au bot.</span><span class="sxs-lookup"><span data-stu-id="f5dac-126">On the provider's site, the user signs in and grants access to the bot.</span></span>
7. <span data-ttu-id="f5dac-127">Le fournisseur emmène l’utilisateur à la page de redirection OAuth du bot avec un code d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="f5dac-127">The provider takes the user to the bot's OAuth redirect page with an authorization code.</span></span>
8. <span data-ttu-id="f5dac-128">Le bot échange le code d’autorisation contre un jeton d’accès et associe **provisoirement** le jeton à l’utilisateur qui a initié le flux de connectement.</span><span class="sxs-lookup"><span data-stu-id="f5dac-128">The bot redeems the authorization code for an access token, and **provisionally** associates the token with the user that initiated the sign-in flow.</span></span> <span data-ttu-id="f5dac-129">Ci-dessous, nous appelons cela *un jeton provisoire*.</span><span class="sxs-lookup"><span data-stu-id="f5dac-129">Below, we call this a *provisional token*.</span></span>
    * <span data-ttu-id="f5dac-130">Dans l’exemple, le bot associe la valeur du `state` paramètre à l’ID de l’utilisateur qui a initié le processus de connectage afin qu’il puisse plus tard le faire correspondre à `state` la valeur retournée par le fournisseur d’identité.</span><span class="sxs-lookup"><span data-stu-id="f5dac-130">In the example, the bot associates the value of the `state` parameter with the ID of the user that initiated the sign-in process so it can later match it with the `state` value returned by the identity provider.</span></span> <span data-ttu-id="f5dac-131">([Voir le code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span><span class="sxs-lookup"><span data-stu-id="f5dac-131">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span></span>
      > [!IMPORTANT] 
      > <span data-ttu-id="f5dac-132">Le bot stocke le jeton qu’il reçoit du fournisseur d’identité et l’associe à un utilisateur spécifique, mais il est marqué comme « validation en attente ».</span><span class="sxs-lookup"><span data-stu-id="f5dac-132">The bot stores the token it receives from the identity provider and associates it with a specific user, but it is marked as "pending validation".</span></span> 
    * <span data-ttu-id="f5dac-133">Le jeton provisoire ne peut pas être utilisé sans validation ultérieure.</span><span class="sxs-lookup"><span data-stu-id="f5dac-133">The provisional token can't be used without further validation.</span></span>
      1. <span data-ttu-id="f5dac-134">**Valider ce qui est reçu du fournisseur d’identité.**</span><span class="sxs-lookup"><span data-stu-id="f5dac-134">**Validate what's received from the identity provider.**</span></span> <span data-ttu-id="f5dac-135">La valeur du paramètre `state` doit être confirmée par rapport à ce qui a été enregistré précédemment.</span><span class="sxs-lookup"><span data-stu-id="f5dac-135">The value of the `state` parameter must be confirmed against what was saved earlier.</span></span> 
      1. <span data-ttu-id="f5dac-136">**Validez ce qui est reçu de Teams.**</span><span class="sxs-lookup"><span data-stu-id="f5dac-136">**Validate what's received from Teams.**</span></span> <span data-ttu-id="f5dac-137">Une validation [d’authentification en](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) deux étapes est effectuée pour s’assurer que l’utilisateur qui a autorisé le bot avec le fournisseur d’identité est le même utilisateur qui discute avec le bot.</span><span class="sxs-lookup"><span data-stu-id="f5dac-137">A [two-step authentication](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) validation is performed to ensure that the user who authorized the bot with the identity provider is the same user who is chatting with the bot.</span></span> <span data-ttu-id="f5dac-138">Cela protège contre [les attaques d’homme au milieu et](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) de [phishing.](https://en.wikipedia.org/wiki/Phishing)</span><span class="sxs-lookup"><span data-stu-id="f5dac-138">This guards against [man-in-the-middle](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) and [phishing](https://en.wikipedia.org/wiki/Phishing) attacks.</span></span> <span data-ttu-id="f5dac-139">Le bot génère un code de vérification et le stocke, associé à l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="f5dac-139">The bot generates a verification code and stores it, associated with the user.</span></span> <span data-ttu-id="f5dac-140">Le code de vérification est envoyé automatiquement par Teams décrit ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="f5dac-140">The verification code is sent automatically by Teams as described below.</span></span> <span data-ttu-id="f5dac-141">([Voir le code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span><span class="sxs-lookup"><span data-stu-id="f5dac-141">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span></span>
9. <span data-ttu-id="f5dac-142">Le rappel OAuth rend une page qui appelle `notifySuccess("<verification code>")` .</span><span class="sxs-lookup"><span data-stu-id="f5dac-142">The OAuth callback renders a page that calls `notifySuccess("<verification code>")`.</span></span> <span data-ttu-id="f5dac-143">([Voir le code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span><span class="sxs-lookup"><span data-stu-id="f5dac-143">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span></span>
10. <span data-ttu-id="f5dac-144">Teams ferme la fenêtre pop-up et envoie `<verification code>` l’envoyé `notifySuccess()` à dos au bot.</span><span class="sxs-lookup"><span data-stu-id="f5dac-144">Teams closes the pop-up window and sends the `<verification code>` sent to `notifySuccess()` back to the bot.</span></span> <span data-ttu-id="f5dac-145">Le bot reçoit un message [d’invocer](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) avec `name = signin/verifyState` .</span><span class="sxs-lookup"><span data-stu-id="f5dac-145">The bot receives an [invoke](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) message with `name = signin/verifyState`.</span></span>
11. <span data-ttu-id="f5dac-146">Le bot vérifie le code de vérification entrant par rapport au code de vérification stocké avec le jeton provisoire de l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="f5dac-146">The bot checks the incoming verification code against the verification code stored with the user's provisional token.</span></span> <span data-ttu-id="f5dac-147">([Voir le code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span><span class="sxs-lookup"><span data-stu-id="f5dac-147">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span></span>
12. <span data-ttu-id="f5dac-148">S’ils correspondent, le bot marque le jeton comme validé et prêt à l’emploi.</span><span class="sxs-lookup"><span data-stu-id="f5dac-148">If they match, the bot marks the token as validated and ready for use.</span></span> <span data-ttu-id="f5dac-149">Sinon, le flux auth échoue, et le bot supprime le jeton provisoire.</span><span class="sxs-lookup"><span data-stu-id="f5dac-149">Otherwise, the auth flow fails, and the bot deletes the provisional token.</span></span>

    > [!NOTE]
    > <span data-ttu-id="f5dac-150">Si vous éprouvez des problèmes d’authentification sur mobile, assurez-vous que votre JavaScript SDK est mis à jour vers la version 1.4.1 ou plus tard.</span><span class="sxs-lookup"><span data-stu-id="f5dac-150">If you experience issues with authentication on mobile, ensure your JavaScript SDK is updated to version 1.4.1 or later.</span></span>

## <a name="code-sample"></a><span data-ttu-id="f5dac-151">Exemple de code</span><span class="sxs-lookup"><span data-stu-id="f5dac-151">Code sample</span></span>

<span data-ttu-id="f5dac-152">Exemple de code montrant le processus d’authentification bot:</span><span class="sxs-lookup"><span data-stu-id="f5dac-152">Sample code showing the bot authentication process:</span></span>

| <span data-ttu-id="f5dac-153">**Nom de l’échantillon**</span><span class="sxs-lookup"><span data-stu-id="f5dac-153">**Sample name**</span></span> | <span data-ttu-id="f5dac-154">**Description**</span><span class="sxs-lookup"><span data-stu-id="f5dac-154">**Description**</span></span> | <span data-ttu-id="f5dac-155">**Node.js**</span><span class="sxs-lookup"><span data-stu-id="f5dac-155">**Node.js**</span></span> | <span data-ttu-id="f5dac-156">**.NET (en)**</span><span class="sxs-lookup"><span data-stu-id="f5dac-156">**.NET**</span></span> | <span data-ttu-id="f5dac-157">**Python**</span><span class="sxs-lookup"><span data-stu-id="f5dac-157">**Python**</span></span> |
|-----------------|----------------|--------------|----------|-----------|
| <span data-ttu-id="f5dac-158">Teams authentification</span><span class="sxs-lookup"><span data-stu-id="f5dac-158">Teams authentication</span></span> | <span data-ttu-id="f5dac-159">Cet exemple démontre l’authentification Microsoft Teams applications.</span><span class="sxs-lookup"><span data-stu-id="f5dac-159">This sample demonstrates authentication in Microsoft Teams apps.</span></span> | [<span data-ttu-id="f5dac-160">View</span><span class="sxs-lookup"><span data-stu-id="f5dac-160">View</span></span>](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) | | |
| <span data-ttu-id="f5dac-161">Authentification bot</span><span class="sxs-lookup"><span data-stu-id="f5dac-161">Bot authentication</span></span> | <span data-ttu-id="f5dac-162">Cet exemple déstarte comment utiliser l’authentification pour un bot runnning dans Microsoft Teams</span><span class="sxs-lookup"><span data-stu-id="f5dac-162">This sample demonstartes how to use authentication for a bot runnning in Microsoft Teams</span></span> | [<span data-ttu-id="f5dac-163">View</span><span class="sxs-lookup"><span data-stu-id="f5dac-163">View</span></span>](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/javascript_nodejs/46.teams-auth) | [<span data-ttu-id="f5dac-164">View</span><span class="sxs-lookup"><span data-stu-id="f5dac-164">View</span></span>](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/csharp_dotnetcore/46.teams-auth) | [<span data-ttu-id="f5dac-165">View</span><span class="sxs-lookup"><span data-stu-id="f5dac-165">View</span></span>](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/python/46.teams-auth)

## <a name="see-also"></a><span data-ttu-id="f5dac-166">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="f5dac-166">See also</span></span>

[<span data-ttu-id="f5dac-167">Ajouter l’authentification à votre bot Teams’argent</span><span class="sxs-lookup"><span data-stu-id="f5dac-167">Add authentication to your Teams bot</span></span>](add-authentication.md)
